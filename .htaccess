# База
Options -Indexes
ServerSignature Off
php_flag expose_php Off
#ServerTokens Prod # 500
#TraceEnable Off # 500


# безопасность заголовков https://securityheaders.com/
<IfModule mod_headers.c>
    # Удаляем следы сервера
    Header always unset Server
    Header always unset X-Powered-By

    # wp
    Header always unset X-Pingback
    Header always unset Link

    # Защита от MIME-сниффинга
    Header always set X-Content-Type-Options "nosniff"

    # Защита от кликджекинга (для старых браузеров)
    Header always set X-Frame-Options "SAMEORIGIN"

    # Политика реферера - передает домен при кросс-доменных запросах
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Политика разрешений - оставляем только необходимое
    Header always set Permissions-Policy "usb=(), magnetometer=(), accelerometer=(), gyroscope=()"

    # Защита от XSS (для старых браузеров)
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>


# tips: RedirectMatch бытрее
# блокировка всего что начинается с "." или "_"
<IfModule mod_alias.c>
    #<FilesMatch "^[._]">
    #    Order Allow,Deny
    #    Deny from all
    #</FilesMatch>
    RedirectMatch 404 /[._][^/]*$
</IfModule>



# блокировка по расширению
<IfModule mod_alias.c>
    #<FilesMatch "\.(back|bak|backup|old|swp|swo|swn|dump|db|sqlite|sqlite3|ini|phps|fla|psd|log|sh|lock|md|sql|tpl|twig|bat|ps|example|yaml|yml|config|conf|config\.js|blade\.php)$">
    #    Order Allow,Deny
    #    Deny from all
    #</FilesMatch>
    RedirectMatch 404 .*\.(txt|back|bak|backup|old|swp|swo|swn|dump|db|sqlite|sqlite3|ini|phps|fla|psd|log|sh|lock|md|sql|tpl|twig|bat|ps|example|yaml|yml|config|conf|config\.js|blade\.php)$
</IfModule>

# блокировка конкретных файлов
<IfModule mod_alias.c>
    #<FilesMatch "^(composer\.json|package\.json|package-lock\.json|phpunit\.xml|phpcs\.xml|phpmd\.xml|Dockerfile|Makefile|LICENSE|wp-config-sample\.php|wp-config\.php|xmlrpc\.php)$">
    #    Order Allow,Deny
    #    Deny from all
    #</FilesMatch>
    RedirectMatch 404 ^/(composer\.json|package\.json|package-lock\.json|phpunit\.xml|phpcs\.xml|phpmd\.xml|Dockerfile|Makefile|LICENSE|wp-config-sample\.php|wp-config\.php|xmlrpc\.php)$
</IfModule>

# Запрещаем PHP во всех папках wp-content (кроме плагинов и тем)
<IfModule mod_alias.c>
#    RedirectMatch 404 /wp-includes/.*\.php$
#    RedirectMatch 404 /cache/.*\.php$
#    RedirectMatch 404 /uploads/.*\.php$
#    RedirectMatch 404 /backup/.*\.php$
#    RedirectMatch 404 /upgrade/.*\.php$
#    RedirectMatch 404 /tmp/.*\.php$
#    RedirectMatch 404 /vendor/.*\.php$
#    RedirectMatch 404 /includes/.*\.php$
#    RedirectMatch 404 /inc/.*\.php$
#    RedirectMatch 404 /themes/.*\.php$
#    RedirectMatch 404 /plugins/.*\.php$
#    RedirectMatch 404 /mu-plugins/.*\.php$
#    RedirectMatch 404 /app/.*\.php$
    RedirectMatch 404 ^/(wp-includes|cache|uploads|backup|upgrade|tmp|vendor|includes|inc|themes|plugins|mu-plugins|app)/.*\.php$
</IfModule>

<FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|js|css|swf|webp|woff2?|ttf|eot|svg)$">
    Header set Cache-Control "max-age=31536000, public"
</FilesMatch>

<IfModule mod_setenvif.c>
    Order Allow,Deny
    Allow from all

    # 1. ПУСТЫЕ USER-AGENT
    SetEnvIf User-Agent "^$" bad_bot
    SetEnvIf User-Agent "^-?$" bad_bot

    # !2. ФЕЙКОВЫЕ Chrome (версии 90- и 130+) не работает
    #SetEnvIfNoCase User-Agent "chrome/([1-8][0-9]\.|90\.|1[3-9][0-9]\.|[2-9][0-9][0-9]\.)" bad_bot

    # 3. УРЕЗАННЫЕ USER-AGENT
    #SetEnvIfNoCase User-Agent "^mozilla/5\.0.*applewebkit/537\.36$" bad_bot

    # 4. ВРЕДОНОСНЫЕ/АГРЕССИВНЫЕ БОТЫ
    SetEnvIfNoCase User-Agent "trendictionbot" bad_bot
    SetEnvIfNoCase User-Agent "geedo" bad_bot
    SetEnvIfNoCase User-Agent "seranking" bad_bot
    SetEnvIfNoCase User-Agent "timpibot" bad_bot
    SetEnvIfNoCase User-Agent "semrushbot" bad_bot
    SetEnvIfNoCase User-Agent "keys-so-bot" bad_bot
    SetEnvIfNoCase User-Agent "wpbot" bad_bot
    SetEnvIfNoCase User-Agent "dataforseo" bad_bot
    SetEnvIfNoCase User-Agent "barkrowler" bad_bot
    SetEnvIfNoCase User-Agent "seekport" bad_bot
    SetEnvIfNoCase User-Agent "backlinks" bad_bot
    SetEnvIfNoCase User-Agent "gigaexplorator" bad_bot
    SetEnvIfNoCase User-Agent "terracotta" bad_bot

    # 5. ЛЕГИТИМНЫЕ БОТЫ
    SetEnvIfNoCase User-Agent "bytespider" bad_bot
    SetEnvIfNoCase User-Agent "petalbot" bad_bot
    SetEnvIfNoCase User-Agent "baidu" bad_bot
    SetEnvIfNoCase User-Agent "oai-searchbot" bad_bot
    SetEnvIfNoCase User-Agent "meta-externalagent" bad_bot
    #SetEnvIfNoCase User-Agent "gptbot" bad_bot
    #SetEnvIfNoCase User-Agent "amazonbot" bad_bot
    #SetEnvIfNoCase User-Agent "twitterbot" bad_bot
    #SetEnvIfNoCase User-Agent "telegrambot" bad_bot
    #SetEnvIfNoCase User-Agent "bingbot" bad_bot

    Deny from env=bad_bot

    # wp scan
    Deny from 20.62.114.0
    # /blocks
</IfModule>
